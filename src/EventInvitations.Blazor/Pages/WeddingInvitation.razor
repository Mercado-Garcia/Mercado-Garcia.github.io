
@using PersonalPortfolio.Library.Domain
@using System.Linq
@implements IDisposable
@using PersonalPortfolio.Library.Domain.Mappers
@inject Library.Infrastructure.IWebsiteRepo WebsiteRepo
@inject IJSRuntime JS

<MudPaper Elevation="0">
    <div class="hero" style="@HeroStyle">
        <canvas id="snow-canvas"></canvas>
        <MudContainer Class="hero-content" MaxWidth="MaxWidth.False">
            <MudText Typo="Typo.h1" Class="couple">@(_wedding?.CoupleNames)</MudText>
            <MudText Typo="Typo.subtitle2" Class="subtitle">@(_wedding?.Subtitle)</MudText>
        </MudContainer>
        <!-- Save the date half-circle badge at the bottom center -->
        <div class="save-the-date">
            <div class="save-the-date__circle">
                <div class="save-the-date__title">Reserva la fecha</div>
                <div class="save-the-date__date date">@(_wedding?.DateText)</div>
            </div>
        </div>
        <MudText Class="scroll-indicator">@(_wedding?.ScrollIndicatorText)</MudText>
    </div>
</MudPaper>

@foreach (var sec in _wedding?.Sections ?? new List<WeddingSection>())
{
    if (sec.Type == WeddingSectionType.Countdown)
    {
        var parts = GetCountdownParts(sec);
        <MudPaper Class="@(sec.AltStyle ? "fade-section alt" : "fade-section")" Elevation="0">
            <MudContainer Class="countdown-section" MaxWidth="MaxWidth.False">
                @if (string.IsNullOrWhiteSpace(sec.FooterText) is false)
                {
                    <MudText Typo="Typo.body2" Align="Align.Center" Class="countdown-footer">@sec.FooterText</MudText>
                }
                @if (string.IsNullOrWhiteSpace(sec.Title) is false)
                {
                    <MudText Typo="Typo.h4" Class="countdown-title">@sec.Title</MudText>
                }
                <div class="countdown-grid">
                    <div class="countdown-box">
                        <div class="countdown-number">@parts.Days</div>
                        <div class="countdown-label">DÍAS</div>
                    </div>
                    <div class="countdown-box">
                        <div class="countdown-number">@parts.Hours.ToString("00")</div>
                        <div class="countdown-label">HORAS</div>
                    </div>
                    <div class="countdown-box">
                        <div class="countdown-number">@parts.Minutes.ToString("00")</div>
                        <div class="countdown-label">MINUTOS</div>
                    </div>
                    <div class="countdown-box">
                        <div class="countdown-number">@parts.Seconds.ToString("00")</div>
                        <div class="countdown-label">SEGUNDOS</div>
                    </div>
                </div>
            </MudContainer>
        </MudPaper>
    }
    else if (sec.Type == WeddingSectionType.Events)
    {
        <MudPaper Class="@(sec.AltStyle ? "fade-section alt" : "fade-section")" Elevation="0">
            <MudContainer Class="events-section" MaxWidth="MaxWidth.False">
                @if (string.IsNullOrWhiteSpace(sec.Title) is false)
                {
                    <MudText Typo="Typo.h4" Class="events-title">@sec.Title</MudText>
                }
                <div class="events-list">
                    @foreach (var ev in sec.Events ?? new List<WeddingEvent>())
                    {
                        <div class="event-item">
                            @if (string.IsNullOrWhiteSpace(ev.Image) is false)
                            {
                                <MudImage Src="@ev.Image" Alt="@ev.ImageAlt" Class="event-image" />
                            }
                            <div class="event-details">
                                <MudText Typo="Typo.h6" Class="event-title">@ev.Title</MudText>
                                @if (string.IsNullOrWhiteSpace(ev.Address) is false)
                                {
                                    <MudText Typo="Typo.body2" Class="event-address">@ev.Address</MudText>
                                }
                                @if (string.IsNullOrWhiteSpace(ev.DateTimeText) is false)
                                {
                                    <MudText Typo="Typo.body2" Class="event-datetime">@ev.DateTimeText</MudText>
                                }
                                @if (string.IsNullOrWhiteSpace(ev.Description) is false)
                                {
                                    <MudText Typo="Typo.body1" Class="event-description">@ev.Description</MudText>
                                }
                                @if (string.IsNullOrWhiteSpace(ev.LocationUrl) is false)
                                {
                                    <MudLink Href="@ev.LocationUrl" Class="event-link">@(string.IsNullOrWhiteSpace(ev.LocationLinkText) ? "Ver ubicación ›" : ev.LocationLinkText)</MudLink>
                                }
                            </div>
                        </div>
                    }
                </div>
            </MudContainer>
        </MudPaper>
    }
    else if (sec.Type == WeddingSectionType.DressCode)
    {
        // Dress code section with a simple two-slide toggle (e.g., Mujeres / Hombres)
        var slides = sec.DressSuggestions ?? new List<DressSuggestion>();
        var current = (slides.Count > 0)
            ? slides.ElementAtOrDefault(Math.Clamp(_dressIndex, 0, slides.Count - 1)) ?? slides[0]
            : null;
        <MudPaper Class="@(sec.AltStyle ? "fade-section alt" : "fade-section")" Elevation="0">
            <MudContainer Class="dresscode-section" MaxWidth="MaxWidth.False">
                @if (string.IsNullOrWhiteSpace(sec.Title) is false)
                {
                    <MudText Typo="Typo.h4" Class="dress-title">@sec.Title</MudText>
                }
                @if ((sec.Paragraphs?.Any() ?? false))
                {
                    <div class="dress-intro">
                        @foreach (var p in sec.Paragraphs)
                        {
                            <MudText Typo="Typo.body1">@p</MudText>
                        }
                    </div>
                }

                @if (current is not null)
                {
                    <div class="dress-slide">
                        @if (string.IsNullOrWhiteSpace(current.Image) is false)
                        {
                            <MudImage Src="@current.Image" Alt="@current.ImageAlt" Class="dress-image" />
                        }
                        <MudText Typo="Typo.h6" Class="dress-subtitle">@current.Title</MudText>
                        @if (string.IsNullOrWhiteSpace(current.StyleLabel) is false || string.IsNullOrWhiteSpace(current.Description) is false)
                        {
                            <MudText Typo="Typo.body1" Class="dress-style">
                                <b>@(string.IsNullOrWhiteSpace(current.StyleLabel) ? string.Empty : current.StyleLabel + " - ")</b>@current.Description
                            </MudText>
                        }
                        @if (string.IsNullOrWhiteSpace(current.Note) is false)
                        {
                            <MudText Typo="Typo.body2" Class="dress-note">@current.Note</MudText>
                        }
                    </div>
                    <div class="dress-dots">
                        @for (var i = 0; i < slides.Count; i++)
                        {
                            var active = i == _dressIndex;
                            <button type="button" class="dress-dot @(active ? "active" : string.Empty)" @onclick="(() => SetDressIndex(i))" aria-label="Cambiar a @(slides[i]?.Title)"></button>
                        }
                    </div>
                }
            </MudContainer>
        </MudPaper>
    }
    else
    {
        <MudPaper Class="@(sec.AltStyle ? "fade-section alt" : "fade-section")" Elevation="0">
            <MudContainer Class="@(sec.Reverse ? "section-inner reverse" : "section-inner")" MaxWidth="MaxWidth.False">
                @if (sec.Reverse)
                {
                    <div class="section-text">
                        <MudText Typo="Typo.h4">@sec.Title</MudText>
                        @foreach (var p in sec.Paragraphs ?? new List<string>())
                        {
                            <MudText Typo="Typo.body1">@p</MudText>
                        }
                        <MudText Typo="Typo.body2" Class="footer-text">@(sec?.FooterText)</MudText>
                    </div>
                    <MudImage Src="@sec.Image" Alt="@sec.ImageAlt" Class="section-image" />
                }
                else
                {
                    <MudImage Src="@sec.Image" Alt="@sec.ImageAlt" Class="section-image" />
                    <div class="section-text">
                        <MudText Typo="Typo.h4">@sec.Title</MudText>
                        @foreach (var p in sec.Paragraphs ?? new List<string>())
                        {
                            <MudText Typo="Typo.body1">@p</MudText>
                        }
                        <MudText Typo="Typo.body2" Class="footer-text">@(sec?.FooterText)</MudText>
                    </div>
                }
            </MudContainer>
        </MudPaper>
    }
}

<MudPaper Class="footer" Elevation="0">
    <MudText Align="Align.Center">@(_wedding?.FooterText)</MudText>

    @if (string.IsNullOrEmpty(_personalInformation?.SocialMediaLinks.Facebook) is false)
    {
        <MudIconButton Icon="@Icons.Custom.Brands.Facebook" Color="Color.Inherit" Href="@UriMapper.GetFacebookUri(_personalInformation.SocialMediaLinks.Facebook)"/>
    }
    @if (string.IsNullOrEmpty(_personalInformation?.SocialMediaLinks.AmazonWishList) is false)
    {
        <MudIconButton Icon="@Icons.Material.Filled.Checklist" Color="Color.Inherit" Href="@UriMapper.GetAmazonWishlistUri(_personalInformation.SocialMediaLinks.AmazonWishList)"/>
    }
</MudPaper>

@code {
    private PersonalInformation _personalInformation;
    private PersonalPortfolio.Library.Domain.WeddingInvitation _wedding;
    private string HeroStyle => string.IsNullOrWhiteSpace(_wedding?.HeroBackgroundImage) ? string.Empty : $"background-image:url('{_wedding.HeroBackgroundImage}');";
    private System.Timers.Timer _countdownTimer;
    private int _dressIndex = 0;

    protected override async Task OnInitializedAsync()
    {
        var siteData = await WebsiteRepo.GetWebsiteData();
        _wedding = siteData.WeddingInvitation;

        var personalData = await WebsiteRepo.GetPersonalInformation();
        _personalInformation = personalData;

        // If there is at least one countdown section, start a 1s timer to update the UI
        if (_wedding?.Sections?.Any(s => s.Type == WeddingSectionType.Countdown) == true)
        {
            _countdownTimer = new System.Timers.Timer(1000);
            _countdownTimer.Elapsed += (_, _) => InvokeAsync(StateHasChanged);
            _countdownTimer.AutoReset = true;
            _countdownTimer.Start();
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await JS.InvokeVoidAsync("weddingSnow.init");
            await JS.InvokeVoidAsync("scrollFade.init");
        }
    }

    public record CountdownParts(int Days, int Hours, int Minutes, int Seconds);

    private CountdownParts GetCountdownParts(WeddingSection sec)
    {
        if (sec is null) return new CountdownParts(0, 0, 0, 0);
        var now = DateTimeOffset.Now;
        if (DateTimeOffset.TryParse(sec.CountdownTarget, out var target) == false)
        {
            // Fallback to the wedding date text if provided and parseable
            if (DateTimeOffset.TryParse(_wedding?.DateText, out var parsedFromText))
                target = parsedFromText;
            else
                target = now;
        }

        if (target <= now) return new CountdownParts(0, 0, 0, 0);

        var diff = target - now;
        var days = (int)Math.Floor(diff.TotalDays);
        var hours = diff.Hours;
        var minutes = diff.Minutes;
        var seconds = diff.Seconds;
        return new CountdownParts(days, hours, minutes, seconds);
    }

    public void Dispose()
    {
        _countdownTimer?.Stop();
        _countdownTimer?.Dispose();
    }

    private void SetDressIndex(int index)
    {
        _dressIndex = index;
    }
}