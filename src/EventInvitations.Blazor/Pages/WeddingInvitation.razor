@using PersonalPortfolio.Library.Domain
@using PersonalPortfolio.Library.Domain.Mappers
@using PersonalPortfolio.Library.Infrastructure
@using System.ComponentModel.DataAnnotations
@using System.Net.Http.Headers
@using System.Timers
@implements IDisposable
@inject IWebsiteRepo WebsiteRepo
@inject IJSRuntime JS
@inject HttpClient Http

<MudPaper Elevation="0">
    <div class="hero" @attributes="HeroAttributes">
        <canvas id="snow-canvas"></canvas>
        <MudContainer Class="hero-content" MaxWidth="MaxWidth.False">
            <MudText Typo="Typo.h1" Class="couple">@(_wedding?.CoupleNames)</MudText>
            <MudText Typo="Typo.subtitle2" Class="subtitle">@(_wedding?.Subtitle)</MudText>
        </MudContainer>
        <!-- Save the date half-circle badge at the bottom center -->
        <div class="save-the-date">
            <div class="save-the-date__circle">
                <div class="save-the-date__title">Reserva la fecha</div>
                <div class="save-the-date__date date">@(_wedding?.DateText)</div>
            </div>
        </div>
        <MudText Class="scroll-indicator">@(_wedding?.ScrollIndicatorText)</MudText>
    </div>
</MudPaper>

@foreach (var sec in _wedding?.Sections ?? new List<WeddingSection>())
{
    if (sec.Type == WeddingSectionType.Countdown)
    {
        var parts = GetCountdownParts(sec);
        <MudPaper Class="@(sec.AltStyle ? "fade-section alt" : "fade-section")" Elevation="0">
            <MudContainer Class="countdown-section" MaxWidth="MaxWidth.False">
                @if (string.IsNullOrWhiteSpace(sec.FooterText) is false)
                {
                    <MudText Typo="Typo.body2" Align="Align.Center" Class="countdown-footer">@sec.FooterText</MudText>
                }
                @if (string.IsNullOrWhiteSpace(sec.Title) is false)
                {
                    <MudText Typo="Typo.h4" Class="countdown-title">@sec.Title</MudText>
                }
                <div class="countdown-grid">
                    <div class="countdown-box">
                        <div class="countdown-number">@parts.Days</div>
                        <div class="countdown-label">DÍAS</div>
                    </div>
                    <div class="countdown-box">
                        <div class="countdown-number">@parts.Hours.ToString("00")</div>
                        <div class="countdown-label">HORAS</div>
                    </div>
                    <div class="countdown-box">
                        <div class="countdown-number">@parts.Minutes.ToString("00")</div>
                        <div class="countdown-label">MINUTOS</div>
                    </div>
                    <div class="countdown-box">
                        <div class="countdown-number">@parts.Seconds.ToString("00")</div>
                        <div class="countdown-label">SEGUNDOS</div>
                    </div>
                </div>
            </MudContainer>
        </MudPaper>
    }
    else if (sec.Type == WeddingSectionType.Events)
    {
        <MudPaper Class="@(sec.AltStyle ? "fade-section alt" : "fade-section")" Elevation="0">
            <MudContainer Class="events-section" MaxWidth="MaxWidth.False">
                @if (string.IsNullOrWhiteSpace(sec.Title) is false)
                {
                    <MudText Typo="Typo.h4" Class="events-title">@sec.Title</MudText>
                }
                <div class="events-list">
                    @foreach (var ev in sec.Events ?? new List<WeddingEvent>())
                    {
                        <div class="event-item">
                            @if (string.IsNullOrWhiteSpace(ev.Image) is false)
                            {
                                <MudImage Src="@ev.Image" Alt="@ev.ImageAlt" Class="event-image" loading="lazy" />
                            }
                            <div class="event-details">
                                <MudText Typo="Typo.h6" Class="event-title">@ev.Title</MudText>
                                @if (string.IsNullOrWhiteSpace(ev.Address) is false)
                                {
                                    <MudText Typo="Typo.body2" Class="event-address">@ev.Address</MudText>
                                }
                                @if (string.IsNullOrWhiteSpace(ev.DateTimeText) is false)
                                {
                                    <MudText Typo="Typo.body2" Class="event-datetime">@ev.DateTimeText</MudText>
                                }
                                @if (string.IsNullOrWhiteSpace(ev.Description) is false)
                                {
                                    <MudText Typo="Typo.body1" Class="event-description">@ev.Description</MudText>
                                }
                                @if (string.IsNullOrWhiteSpace(ev.LocationUrl) is false)
                                {
                                    <MudLink Href="@ev.LocationUrl" Target="_blank" Class="event-link">@(string.IsNullOrWhiteSpace(ev.LocationLinkText) ? "Ver ubicación ›" : ev.LocationLinkText)</MudLink>
                                }
                            </div>
                        </div>
                    }
                </div>
            </MudContainer>
        </MudPaper>
    }
    else if (sec.Type == WeddingSectionType.DressCode)
    {
        <MudPaper Class="@(sec.AltStyle ? "fade-section alt" : "fade-section")" Elevation="0">
            <MudContainer Class="dresscode-section" MaxWidth="MaxWidth.False">
                @if (string.IsNullOrWhiteSpace(sec.Title) is false)
                {
                    <MudText Typo="Typo.h4" Class="dress-title">@sec.Title</MudText>
                }
                @if ((sec.Paragraphs?.Any() ?? false))
                {
                    <div class="dress-intro">
                        @foreach (var p in sec.Paragraphs)
                        {
                            <MudText Typo="Typo.body1">@p</MudText>
                        }
                    </div>
                }

                <div class="dress-slide">
                    @if (string.IsNullOrWhiteSpace(sec.Image) is false)
                    {
                        <MudImage Src="@sec.Image" Alt="@sec.ImageAlt" Class="dress-image" loading="lazy" />
                    }
                    @if (string.IsNullOrWhiteSpace(sec.FooterText) is false)
                    {
                        <MudText Typo="Typo.body1" Class="dress-note"><b>@sec.FooterText</b></MudText>
                    }
                </div>
            </MudContainer>
        </MudPaper>
    }
    else if (sec.Type == WeddingSectionType.Gifts)
    {
        <MudPaper Class="@(sec.AltStyle ? "fade-section alt gifts-bg" : "fade-section gifts-bg")"
                  @attributes="GetSectionAttributes(sec)"
                  Elevation="0">
            @if (!string.IsNullOrWhiteSpace(sec.Image))
            {
                <div class="section-overlay"></div>
            }
            <MudContainer Class="gifts-section" MaxWidth="MaxWidth.False">
                @if (string.IsNullOrWhiteSpace(sec.Title) is false)
                {
                    <MudText Typo="Typo.h4" Class="gifts-title">@sec.Title</MudText>
                }

                <div class="gifts-box">
                    <div class="gifts-divider-top">
                        <div class="line"></div>
                        <MudIcon Icon="@Icons.Material.Outlined.CardGiftcard" Class="gifts-icon-top" />
                        <div class="line"></div>
                    </div>

                    <div class="gifts-body">
                        @if (sec.Paragraphs != null && sec.Paragraphs.Count > 0)
                        {
                            <MudText Typo="Typo.body1" Class="gifts-text primary-text">@sec.Paragraphs[0]</MudText>
                        }

                        @if (sec.Paragraphs != null && sec.Paragraphs.Count > 1)
                        {
                            <MudText Typo="Typo.body1" Class="gifts-text secondary-text">@sec.Paragraphs[1]</MudText>
                        }

                        <div class="gifts-divider-line"></div>
                        <MudText Typo="Typo.h5" Class="gifts-subtitle">LLUVIA DE SOBRES</MudText>
                        <div class="gifts-divider-line"></div>

                        <div class="gifts-icon-container">
                            <div class="gifts-icon-envelope-wrapper">
                                <svg class="envelope-svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M2 6v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2H4c-1.1 0-2 .9-2 2z"></path>
                                    <polyline class="envelope-flap" points="22,6 12,13 2,6"></polyline>
                                </svg>
                            </div>
                        </div>

                        @if (sec.Paragraphs != null && sec.Paragraphs.Count > 2)
                        {
                            <MudText Typo="Typo.body1" Class="gifts-footer-text">@sec.Paragraphs[2]</MudText>
                        }
                    </div>
                </div>
            </MudContainer>
        </MudPaper>
    }
    else if (sec.Type == WeddingSectionType.Photos)
    {
        <MudPaper Class="@(sec.AltStyle ? "fade-section alt" : "fade-section")" Elevation="0">
            <MudContainer Class="photos-section-container" MaxWidth="MaxWidth.False">
                <div class="section-text centered">
                    @if (string.IsNullOrWhiteSpace(sec.Title) is false)
                    {
                        <MudText Typo="Typo.h4" Align="Align.Center">@sec.Title</MudText>
                    }
                    @if (sec.Paragraphs?.Count > 0)
                    {
                        <MudText Typo="Typo.body1" Align="Align.Center">@sec.Paragraphs[0]</MudText>
                    }
                </div>

                <div class="camera-container">
                    <svg class="camera-svg" viewBox="0 0 200 160" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <!-- Camera Body & Lens -->
                        <path class="camera-path" d="M40,60 Q40,50 50,50 H70 L80,30 H120 L130,50 H150 Q160,50 160,60 V120 Q160,130 150,130 H50 Q40,130 40,120 Z M70,90 A30,30 0 1,0 130,90 A30,30 0 1,0 70,90" />
                    </svg>
                    @if (sec.ShowQrCode)
                    {
                        <div class="qr-code-wrapper">
                            <img src="https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=@(Uri.EscapeDataString(sec.ActionUrl ?? ""))" alt="QR Code" class="qr-code-image" />
                        </div>
                    }
                </div>

                <div class="section-text centered">
                    @if (sec.Paragraphs?.Count > 1)
                    {
                        @foreach (var p in sec.Paragraphs.Skip(1))
                        {
                            <MudText Typo="Typo.body1" Align="Align.Center">@p</MudText>
                        }
                    }

                    @if (string.IsNullOrWhiteSpace(sec.ActionUrl) is false)
                    {
                        <div class="action-container" style="margin-top: 1.5rem; display: flex; justify-content: center;">
                            <MudButton Variant="Variant.Filled"
                                       Color="Color.Primary"
                                       Href="@sec.ActionUrl"
                                       Target="_blank"
                                       StartIcon="@Icons.Material.Filled.PhotoCamera"
                                       Style="border-radius: 50px; padding: 10px 30px; font-weight: 600;">
                                @(string.IsNullOrWhiteSpace(sec.ActionText) ? "Subir fotos" : sec.ActionText)
                            </MudButton>
                        </div>
                    }
                    <MudText Typo="Typo.body2" Class="footer-text" Align="Align.Center">@(sec?.FooterText)</MudText>
                </div>
            </MudContainer>
        </MudPaper>
    }
    else
    {
        <MudPaper Class="@(sec.AltStyle ? "fade-section alt" : "fade-section")" Elevation="0">
            <MudContainer Class="@(sec.Reverse ? "section-inner reverse" : "section-inner")" MaxWidth="MaxWidth.False">
                @if (sec.Reverse)
                {
                    <div class="section-text">
                        <MudText Typo="Typo.h4">@sec.Title</MudText>
                        @foreach (var p in sec.Paragraphs ?? new List<string>())
                        {
                            <MudText Typo="Typo.body1">@p</MudText>
                        }
                        <MudText Typo="Typo.body2" Class="footer-text">@(sec?.FooterText)</MudText>
                    </div>
                    <MudImage Src="@sec.Image" Alt="@sec.ImageAlt" Class="section-image" loading="lazy" />
                }
                else
                {
                    <MudImage Src="@sec.Image" Alt="@sec.ImageAlt" Class="section-image" loading="lazy" />
                    <div class="section-text">
                        <MudText Typo="Typo.h4">@sec.Title</MudText>
                        @foreach (var p in sec.Paragraphs ?? new List<string>())
                        {
                            <MudText Typo="Typo.body1">@p</MudText>
                        }
                        <MudText Typo="Typo.body2" Class="footer-text">@(sec?.FooterText)</MudText>
                    </div>
                }
            </MudContainer>
        </MudPaper>
    }
}

<!-- RSVP Section (Formspree + hCaptcha) -->
<MudPaper Class="@($"rsvp-section{(string.IsNullOrWhiteSpace(_wedding?.HeroBackgroundImage) ? string.Empty : " with-bg")}")" Elevation="0" @attributes="RsvpAttributes">
    <MudContainer Class="section-inner" MaxWidth="MaxWidth.False">
        <div class="section-text">
            <div class="rsvp-title">Confirma tu asistencia</div>
            @if (string.IsNullOrWhiteSpace(_wedding?.DateText) is false)
            {
                <div class="rsvp-subtitle">Por favor, reserva antes de @_wedding.DateText.</div>
            }

            <EditForm Model="_rsvp" OnValidSubmit="SubmitRsvpAsync">
                <DataAnnotationsValidator />

                <div class="rsvp-form-grid">
                    <div class="form-field">
                        <input id="name" type="text" placeholder="Tu nombre" @bind="_rsvp.Name" />
                    </div>

                    <div class="form-field">
                        <input id="email" type="email" placeholder="Tu email*" @bind="_rsvp.Email" required />
                    </div>

                    <div class="form-field">
                        <input id="guests" type="number" min="1" max="10" placeholder="Número de invitados" @bind="_rsvp.Guests" disabled="@(!_rsvp.IsAttending)" />
                    </div>

                    <div class="form-field">
                        <InputSelect @bind-Value="_rsvp.IsAttending" id="attending">
                            <option value="true">Asistiré *</option>
                            <option value="false">No podré asistir *</option>
                        </InputSelect>
                    </div>

                    <div class="form-field full">
                        <textarea id="message" rows="6" placeholder="Tu mensaje" @bind="_rsvp.Message"></textarea>
                    </div>


                    <div class="rsvp-actions full">
                        <button type="submit" class="mud-button mud-button-filled mud-button-filled-primary" disabled="@_submitting">
                            @(_submitting ? "Enviando..." : "Enviar invitación")
                        </button>
                    </div>
                </div>
            </EditForm>

            @if (string.IsNullOrWhiteSpace(_submitMessage) is false)
            {
                <MudText Typo="Typo.body2" Color="@(_submitSuccess ? Color.Success : Color.Error)" Class="rsvp-message mt-2">@_submitMessage</MudText>
            }
        </div>
    </MudContainer>
</MudPaper>

<MudPaper Class="footer" Elevation="0">
    <MudText Align="Align.Center">@(_wedding?.FooterText)</MudText>

    @if (string.IsNullOrEmpty(_personalInformation?.SocialMediaLinks.Facebook) is false)
    {
        <MudIconButton Icon="@Icons.Custom.Brands.Facebook" Color="Color.Inherit" Href="@UriMapper.GetFacebookUri(_personalInformation.SocialMediaLinks.Facebook)"/>
    }
    @if (string.IsNullOrEmpty(_personalInformation?.SocialMediaLinks.AmazonWishList) is false)
    {
        <MudIconButton Icon="@Icons.Material.Filled.Checklist" Color="Color.Inherit" Href="@UriMapper.GetAmazonWishlistUri(_personalInformation.SocialMediaLinks.AmazonWishList)"/>
    }
</MudPaper>

@code {
    private PersonalInformation _personalInformation;
    private Library.Domain.WeddingInvitation _wedding;
    private const string FormspreeEndpoint = "https://formspree.io/f/meoybpvz";
    private string HeroStyle => string.IsNullOrWhiteSpace(_wedding?.HeroBackgroundImage) ? string.Empty : $"background-image:url('{_wedding.HeroBackgroundImage}');";
    private IReadOnlyDictionary<string, object> HeroAttributes =>
        string.IsNullOrWhiteSpace(_wedding?.HeroBackgroundImage)
            ? new Dictionary<string, object>()
            : new Dictionary<string, object> { ["style"] = $"background-image:url('{_wedding.HeroBackgroundImage}');" };
    private IReadOnlyDictionary<string, object> RsvpAttributes =>
        string.IsNullOrWhiteSpace(_wedding?.HeroBackgroundImage)
            ? new Dictionary<string, object>()
            : new Dictionary<string, object> { ["style"] = $"background-image:url('{_wedding.HeroBackgroundImage}');" };

    private IReadOnlyDictionary<string, object> GetSectionAttributes(WeddingSection sec) =>
        string.IsNullOrWhiteSpace(sec?.Image)
            ? new Dictionary<string, object>()
            : new Dictionary<string, object> { ["style"] = $"background-image:url('{sec.Image}');" };

    private Timer _countdownTimer;

    protected override async Task OnInitializedAsync()
    {
        var siteData = await WebsiteRepo.GetWebsiteData();
        _wedding = siteData.WeddingInvitation;

        var personalData = await WebsiteRepo.GetPersonalInformation();
        _personalInformation = personalData;

        // If there is at least one countdown section, start a 1s timer to update the UI
        if (_wedding?.Sections?.Any(s => s.Type == WeddingSectionType.Countdown) == true)
        {
            _countdownTimer = new Timer(1000);
            _countdownTimer.Elapsed += (_, _) => InvokeAsync(StateHasChanged);
            _countdownTimer.AutoReset = true;
            _countdownTimer.Start();
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await JS.InvokeVoidAsync("weddingSnow.init");
            await JS.InvokeVoidAsync("scrollFade.init");
            await JS.InvokeVoidAsync("backgroundMusic.init", "music/wedding-background-music.mp3");
        }
    }

    public record CountdownParts(int Days, int Hours, int Minutes, int Seconds);

    private CountdownParts GetCountdownParts(WeddingSection sec)
    {
        if (sec is null) return new CountdownParts(0, 0, 0, 0);
        var now = DateTimeOffset.Now;
        if (DateTimeOffset.TryParse(sec.CountdownTarget, out var target) == false)
        {
            // Fallback to the wedding date text if provided and parseable
            if (DateTimeOffset.TryParse(_wedding?.DateText, out var parsedFromText))
                target = parsedFromText;
            else
                target = now;
        }

        if (target <= now) return new CountdownParts(0, 0, 0, 0);

        var diff = target - now;
        var days = (int)Math.Floor(diff.TotalDays);
        var hours = diff.Hours;
        var minutes = diff.Minutes;
        var seconds = diff.Seconds;
        return new CountdownParts(days, hours, minutes, seconds);
    }

    public void Dispose()
    {
        _countdownTimer?.Stop();
        _countdownTimer?.Dispose();
    }

    private RsvpModel _rsvp = new();
    private bool _submitting;
    private bool _submitSuccess;
    private string _submitMessage = string.Empty;

    private string EmailValidator(string value)
        => string.IsNullOrWhiteSpace(value) || !new EmailAddressAttribute().IsValid(value)
            ? "Ingresa un email válido"
            : null;

    private async Task SubmitRsvpAsync()
    {
        _submitting = true;
        _submitMessage = string.Empty;
        _submitSuccess = false;
        StateHasChanged();

        try
        {
            if (string.IsNullOrWhiteSpace(_rsvp.Email))
            {
                _submitMessage = "El email es obligatorio.";
                _submitSuccess = false;
                return;
            }

            var payload = new Dictionary<string, object>
            {
                ["name"] = _rsvp.Name ?? string.Empty,
                ["isAttending"] = _rsvp.IsAttending,
                ["guests"] = _rsvp.IsAttending ? Math.Max(1, _rsvp.Guests) : 0,
                ["email"] = _rsvp.Email,
                ["message"] = _rsvp.Message ?? string.Empty
            };

            var req = new HttpRequestMessage(HttpMethod.Post, FormspreeEndpoint)
            {
                Content = JsonContent.Create(payload)
            };
            req.Headers.Accept.Add(new MediaTypeWithQualityHeaderValue("application/json"));

            var resp = await Http.SendAsync(req);
            if (resp.IsSuccessStatusCode)
            {
                _submitSuccess = true;
                _submitMessage = "¡Gracias! Tu respuesta ha sido enviada.";
                _rsvp = new RsvpModel();
            }
            else
            {
                var responseBody = await resp.Content.ReadAsStringAsync();
                _submitSuccess = false;
                _submitMessage = "No se pudo enviar. Intenta nuevamente más tarde.";
            }
        }
        catch
        {
            _submitSuccess = false;
            _submitMessage = "Ocurrió un error. Intenta nuevamente.";
        }
        finally
        {
            _submitting = false;
        }
    }

    public class RsvpModel
    {
        public string Name { get; set; } = string.Empty;
        public bool IsAttending { get; set; } = true;
        public int Guests { get; set; } = 1;
        public string Email { get; set; } = string.Empty;
        public string Message { get; set; }
    }

}